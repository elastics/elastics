<!DOCTYPE html>
<html>
  <head>
    <link href='/elastics/assets/global-74df1a51e3d7075c146b619ddfd07904.css' rel='stylesheet' type='text/css' />
<script src='/elastics/assets/global-aacc71e3a462796a62993fb5a8b696a3.js' type='text/javascript'></script>
<title>Elastics - elastics-client - Result Extenders</title>
    <meta charset="UTF-8" />
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-42574355-3', 'elasticston
      .github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div id="page-nav" class="nocontent">
      <ul id="nav-menu" class="menu_h_list"><li><a href="#" class="isLabel">elastics</a><ul><li><a href="/elastics/doc/1-elastics/1-Overview.html">Elastics Overview</a></li><li><a href="/elastics/doc/1-elastics/2-Usage-Overview.html">Usage Overview</a></li><li><a href="/elastics/doc/1-elastics/3-Configuration.html">Configuration</a></li><li><a href="/elastics/doc/1-elastics/4-Rake-Tasks.html">Rake Tasks</a></li></ul></li><li><a href="#" class="isLabel">elastics-client</a><ul><li><a href="/elastics/doc/2-elastics-client/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/2-elastics-client/2-API-Methods.html">API Methods</a></li><li><a href="#" class="isLabel">Templating</a><div class="arrow right"></div><ul><li><a href="/elastics/doc/2-elastics-client/3-Templating/1-Templates.html">Templates</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/2-Sources.html">Template Sources</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/3-Tags.html">Tags</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/4-Variables.html">Variables</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/5-Interpolation.html">Interpolation</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/6-Partials.html">Partial Templates</a></li></ul></li><li><a href="/elastics/doc/2-elastics-client/4-Result-Extenders.html">Result Extenders</a></li><li><a href="/elastics/doc/2-elastics-client/5-Self-Documentation.html">Self Documentation</a></li><li><a href="/elastics/doc/2-elastics-client/6-Utility-Methods.html">Utility Methods</a></li></ul></li><li><a href="#" class="isLabel">elastics-scopes</a><ul><li><a href="/elastics/doc/3-elastics-scopes/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/3-elastics-scopes/2-Scopes.html">Scopes</a></li></ul></li><li><a href="#" class="isLabel">elastics-models</a><ul><li><a href="/elastics/doc/4-elastics-models/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/4-elastics-models/2-ActiveRecord-And-Mongoid-Integration.html">ActiveRecord And Mongoid Integration</a></li><li><a href="/elastics/doc/4-elastics-models/3-ActiveModel-Integration.html">ActiveModel Integration</a></li><li><a href="#" class="isLabel">Modules</a><div class="arrow right"></div><ul><li><a href="/elastics/doc/4-elastics-models/4-Modules/1-Elastics::ModelSyncer.html">Elastics::ModelSyncer</a></li><li><a href="/elastics/doc/4-elastics-models/4-Modules/2-Elastics::ModelIndexer.html">Elastics::ModelIndexer</a></li><li><a href="/elastics/doc/4-elastics-models/4-Modules/3-Elastics::ActiveModel.html">Elastics::ActiveModel</a></li></ul></li><li><a href="/elastics/doc/4-elastics-models/5-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">elastics-rails</a><ul><li><a href="/elastics/doc/5-elastics-rails/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/5-elastics-rails/2-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">elastics-admin</a><ul><li><a href="/elastics/doc/6-elastics-admin/1-Binary.html">Binary</a></li><li><a href="/elastics/doc/6-elastics-admin/2-Live-Reindex.html">Live Reindex</a></li></ul></li><li><a href="#" class="isLabel">tutorials</a><ul><li><a href="/elastics/doc/7-tutorials/1-Elastics-vs-Tire.html">Why you should use Elastics rather than Tire</a></li><li><a href="/elastics/doc/7-tutorials/2-Migrate-from-0.x.html">How to migrate from Flex 0.x</a></li><li><a href="/elastics/doc/7-tutorials/3-Index-and-Search-your-Models.html">Index and Search your Models</a></li><li><a href="/elastics/doc/7-tutorials/4-Index-and-Search-External-Data.html">Index and Search External Data</a></li></ul></li></ul>
      <div id="google-search">
        <script type="text/javascript">
          (function() {
            var cx = '001168365143071728136:w4opkcwdl3y';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
        <gcse:search>&nbsp;</gcse:search>
      </div>
    </div>
    <div id="page-toc">
      <div id="logo">
        <img src="/elastics/images/elastics-logo-200.png" />
      </div>
    </div>
    <div id="content">
      <a id="badge" href="https://badge.fury.io/rb/elastics-client"><img src="https://badge.fury.io/rb/elastics-client.png" /></a>
      <div class="breadcrumb nocontent">
        <span><a href="/elastics/doc">Elastics</a></span> &gt; <span><a href="/elastics/doc/2-elastics-client">elastics-client</a></span> &gt; <span>Result Extenders</span>
      </div>
      <h1 id="elastics-client---result-extenders">elastics-client - Result Extenders</h1>

<p>Each result that comes from a Elastics request is the same data structure that comes from the elasticsearch response. It is the untouched structure (hash) that you would expect from the request you did, so you can always inspect and interact with it directly.</p>

<p>However Elastics implements also a mechanism that allows to extend the structure in place, with the useful methods that makes sense with the particular result retrieved. Elastics do so with a few Extender modules, that extend the original <code>Elastics::Result</code> hash object. Writing your own extender is extremely easy and recommended for more specialized methods.</p>

<p>For example the structure returned from a search query, is the regular structure that elasticsearch serves, but you can call more methods on that hash or on part of that structure, because Elastics extends them in place. For example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># search the index</span>
<span class="n">result</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">my_search</span> <span class="ss">:my_tag</span> <span class="o">=&gt;</span> <span class="s1">&#39;the tag value&#39;</span>
<span class="c1">#=&gt; { ... tipical response from elasticsearch ... }</span>

<span class="c1"># get the document directly from the elasticsearch structure</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;hits&#39;</span><span class="o">][</span><span class="s1">&#39;hits&#39;</span><span class="o">]</span>
<span class="c1">#=&gt; [ ... the hits array ... ]</span>

<span class="c1"># or use a method added by elastics</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">collection</span>
<span class="c1">#=&gt; [ ... same object as above ... ]</span>

<span class="c1"># also the collection array is extended with the tipical methods for pagination as well</span>
<span class="n">collection</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span> <span class="c1">#=&gt; true</span>
<span class="n">collection</span><span class="o">.</span><span class="n">total_entries</span>
<span class="n">collection</span><span class="o">.</span><span class="n">per_page</span>
<span class="n">collection</span><span class="o">.</span><span class="n">total_pages</span>
<span class="n">collection</span><span class="o">.</span><span class="n">current_page</span>

<span class="c1"># the documents gets also extended</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">first</span>
<span class="n">document</span><span class="o">.</span><span class="n">id</span>
<span class="n">document</span><span class="o">.</span><span class="n">type</span>
<span class="n">document</span><span class="o">.</span><span class="n">any_attribute</span></code></pre></div>

<p>The important concept to know is that the Elastics extension mechanism leaves the elasticsearch structure received always intact, it just extends the structure with utility methods and shortcuts where it makes sense.</p>

<h2 id="elastics-result-extenders">Elastics Result Extenders</h2>

<p>The <code>elastics-client</code> gem comes with a few extenders (documented here) and more are added by other gems (see <a href="/elastics/doc/4-elastics-models/5-Result-Extenders.html">Result Extenders</a>). They are applied to the particular structure they make sense for. So a single structure could be extended by more than one extender or by none, depending on what applies to that structure.</p>

<ul>
  <li>
    <p><strong><code>Elastics::Result::Search</code></strong><br />
It extends the results coming from a search query. It adds the following methods:</p>

    <ul>
      <li>
        <p><strong><code>result.collection</code></strong><br />
It is the shortcut to <code>result['hits']['hits']</code> from search results. The collection is extended by the typical pagination methods (see <a href="/elastics/doc/2-elastics-client/4-Result-Extenders.html#elasticsresultcollection">Elastics::Result::Collection</a>), Besides, each hit in the array gets extended also by the <code>Elastics::Result::Document</code> extender (see below).</p>
      </li>
      <li>
        <p><strong><code>result.facets</code></strong><br />
Just a shortcut for <code>result['facets']</code></p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code>Elastics::Result::MultiGet</code></strong><br />
It extends the results coming from a multi-get query. It adds the following methods:</p>

    <ul>
      <li><strong><code>result.docs</code></strong> or <strong><code>result.collection</code></strong><br />
It is the shortcut to <code>result['docs']</code> from multi-get results. The collection is extended by the typical pagination methods (see <a href="/elastics/doc/2-elastics-client/4-Result-Extenders.html#elasticsresultcollection">Elastics::Result::Collection</a>), Besides, each hit in the array gets extended also by the <code>Elastics::Result::Document</code> extender (see below).</li>
    </ul>
  </li>
  <li>
    <p><strong><code>Elastics::Result::Document</code></strong><br />
Applies to documents that contain (at least, but not limited to) <code>_index</code>, <code>_type</code>, <code>_id</code>. It adds the following methods:</p>

    <ul>
      <li>
        <p><strong><code>document.index</code></strong>, <strong><code>document.type</code></strong>, <strong><code>document.id</code></strong><br />
Shortcuts methods pointing to <code>document['_index']</code>, <code>document['_type']</code>, <code>document['_id']</code></p>
      </li>
      <li>
        <p><strong><code>document.index_basename</code></strong><br />
Returns the unprefixed index name:  <code>my_index</code> for the <code>20130608103457_my_index</code> index (see <a href="/elastics/doc/6-elastics-admin/2-Live-Reindex.html#index_renaming">Index Renaming</a>).</p>
      </li>
      <li>
        <p><strong><code>method_missing</code></strong><br />
This module extends the <code>_source</code> by supplying object-like readers methods. It also exposes the meta fields like _id, _source, etc. For example:</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code>Elastics::Result::Bulk</code></strong><br />
Applies to the responses returned after sending a bulk post. Used internally by the <code>elastics::import</code> rake task (see <a href="/elastics/doc/1-elastics/4-Rake-Tasks.html">Rake Tasks</a>). Adds the following methods:</p>

    <ul>
      <li>
        <p><strong><code>successful</code></strong><br />
Array of the items that elasticsearch marked as ‘ok’</p>
      </li>
      <li>
        <p><strong><code>failed</code></strong><br />
Array of the items that elasticsearch marked as not ‘ok’</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="elasticsresultcollection">Elastics::Result::Collection</h2>

<p>Provides the pagination-like methods and aliases in order to support both <code>will_paginate</code> and <code>kaminari</code></p>

<ul>
  <li><code>total_entries</code></li>
  <li><code>per_page</code></li>
  <li><code>total_pages</code></li>
  <li><code>current_page</code></li>
  <li><code>previous_page</code></li>
  <li><code>next_page</code></li>
  <li><code>offset</code></li>
  <li><code>out_of_bounds?</code></li>
  <li><code>limit_value</code></li>
  <li><code>total_count</code></li>
  <li><code>num_pages</code></li>
  <li><code>offset_value</code></li>
</ul>

<h2 id="custom-result-extenders">Custom Result Extenders</h2>

<p>An extender is simply a module that is included in the <code>Elastics::Configuration.result_extenders</code> array. You can manipulate that array if you wish, by adding or removing modules, so adding or removing methods to the original result structure returned by elasticsearch. For example, let’s say that you would like to be able to do:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">result</span> <span class="o">=</span> <span class="no">MySearch</span><span class="o">.</span><span class="n">some_search</span>
<span class="n">custom_structure</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">type_counts</span></code></pre></div>

<p>and the <code>type_counts</code> should do some arbitrary aggregation on the returned facet counts, returning a custom structure that you need to pass around.</p>

<p>First you write a module with the methods that will be used to extend the original result. A simplified real world example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">MyExtender</span>

  <span class="c1"># returns a structure like:</span>
  <span class="c1"># {:total=&gt;294, :blogs=&gt;5, :projects=&gt;1, :products=&gt;1, :forums=&gt;287}</span>
  <span class="k">def</span> <span class="nf">type_counts</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">[</span><span class="s1">&#39;facets&#39;</span><span class="o">][</span><span class="s1">&#39;type_counts&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">term</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">]</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span>
      <span class="n">counts</span><span class="o">[</span><span class="n">term</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span>
    <span class="k">end</span>
    <span class="n">counts</span><span class="o">[</span><span class="ss">:forums</span><span class="o">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">[</span><span class="ss">:threads</span><span class="o">]</span> <span class="o">+</span> <span class="n">counts</span><span class="o">[</span><span class="ss">:posts</span><span class="o">]</span>
    <span class="n">counts</span><span class="o">[</span><span class="ss">:total</span><span class="o">]</span> <span class="o">=</span> <span class="nb">self</span><span class="o">[</span><span class="s1">&#39;facets&#39;</span><span class="o">][</span><span class="s1">&#39;type_counts&#39;</span><span class="o">][</span><span class="s1">&#39;total&#39;</span><span class="o">]</span>
    <span class="n">counts</span>
  <span class="k">end</span>

  <span class="c1"># tells Elastics whether to extend the result with this module or not</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">should_extend?</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span> <span class="o">=~</span> <span class="sr">/\b_search\b/</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;facets&#39;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;facets&#39;</span><span class="o">][</span><span class="s1">&#39;type_counts&#39;</span><span class="o">]</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></div>

<p>Notice that in that module <code>self</code> is the returned elasticsearch structure. As you see the method <code>type_counts</code> elaborates the facets ‘type_counts’ returning the custom structure that we need.</p>

<p>Also notice that unless we want to extend ALL the results returned from elasticsearch, we define a <code>should_extend?</code> class method that will check if the result contains what we expect, so extending only when it makes sense.</p>

<p>Now you want to add it to the list of extenders (usually in the <code>elastics.rb</code> initializer if you are doing it in Rails)</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Elastics</span><span class="o">::</span><span class="no">Configuration</span><span class="o">.</span><span class="n">result_extenders</span> <span class="o">&lt;&lt;</span> <span class="no">MyExtender</span></code></pre></div>

<p>You could have done the same thing with an external helper, passing it the facet object, something like:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">result</span> <span class="o">=</span> <span class="no">MySearch</span><span class="o">.</span><span class="n">some_search</span>
<span class="n">custom_structure</span> <span class="o">=</span> <span class="n">type_count</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">facets</span><span class="p">)</span></code></pre></div>

<p>It all depends whether you want to put the logic of what you are doing. Personally I prefer the first approach, which looks more OO and self-contained, specially if you have a lot of result related methods, but in this particular case even the functional approach might be OK.</p>

<h3 id="modelelasticsresultresult">Model.elastics_result(result)</h3>

<p>If your context class defines it, it is internally called by elastics just before returning the result, so you can change it as you prefer, maybe creating objects, extending, checking, whatever. You have also access to the final variables through the passed result. For example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">elastics_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="n">vars</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">variables</span>
  <span class="n">vars</span><span class="o">[</span><span class="ss">:my_class_wrapper</span><span class="o">]</span> <span class="p">?</span> <span class="n">vars</span><span class="o">[</span><span class="ss">:my_class_wrapper</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">:</span> <span class="n">result</span>
<span class="k">end</span></code></pre></div>

<br />
      <div class="breadcrumb nocontent">
        <span><a href="/elastics/doc">Elastics</a></span> &gt; <span><a href="/elastics/doc/2-elastics-client">elastics-client</a></span> &gt; <span>Result Extenders</span>
      </div>
    </div>
    <div id="footer" class="nocontent">
      Copyright &copy; 2012-2013 by <a href="mailto://dd.nexus@gmail.com">Domizio Demichelis</a> &mdash; Sponsored by <a href="http://www.escalatemedia.com">Escalate Media</a> and <a href="http://www.barquin.com">Barquin International</a>
    </div>
  </body>
</html>