<!DOCTYPE html>
<html>
  <head>
    <link href='/elastics/assets/global-74df1a51e3d7075c146b619ddfd07904.css' rel='stylesheet' type='text/css' />
<script src='/elastics/assets/global-aacc71e3a462796a62993fb5a8b696a3.js' type='text/javascript'></script>
<title>Elastics - elastics-models - Elastics::ActiveModel</title>
    <meta charset="UTF-8" />
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-42574355-3', 'elasticston
      .github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div id="page-nav" class="nocontent">
      <ul id="nav-menu" class="menu_h_list"><li><a href="#" class="isLabel">elastics</a><ul><li><a href="/elastics/doc/1-elastics/1-Overview.html">Elastics Overview</a></li><li><a href="/elastics/doc/1-elastics/2-Usage-Overview.html">Usage Overview</a></li><li><a href="/elastics/doc/1-elastics/3-Configuration.html">Configuration</a></li><li><a href="/elastics/doc/1-elastics/4-Rake-Tasks.html">Rake Tasks</a></li></ul></li><li><a href="#" class="isLabel">elastics-client</a><ul><li><a href="/elastics/doc/2-elastics-client/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/2-elastics-client/2-API-Methods.html">API Methods</a></li><li><a href="#" class="isLabel">Templating</a><div class="arrow right"></div><ul><li><a href="/elastics/doc/2-elastics-client/3-Templating/1-Templates.html">Templates</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/2-Sources.html">Template Sources</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/3-Tags.html">Tags</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/4-Variables.html">Variables</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/5-Interpolation.html">Interpolation</a></li><li><a href="/elastics/doc/2-elastics-client/3-Templating/6-Partials.html">Partial Templates</a></li></ul></li><li><a href="/elastics/doc/2-elastics-client/4-Result-Extenders.html">Result Extenders</a></li><li><a href="/elastics/doc/2-elastics-client/5-Self-Documentation.html">Self Documentation</a></li><li><a href="/elastics/doc/2-elastics-client/6-Utility-Methods.html">Utility Methods</a></li></ul></li><li><a href="#" class="isLabel">elastics-scopes</a><ul><li><a href="/elastics/doc/3-elastics-scopes/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/3-elastics-scopes/2-Scopes.html">Scopes</a></li></ul></li><li><a href="#" class="isLabel">elastics-models</a><ul><li><a href="/elastics/doc/4-elastics-models/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/4-elastics-models/2-ActiveRecord-And-Mongoid-Integration.html">ActiveRecord And Mongoid Integration</a></li><li><a href="/elastics/doc/4-elastics-models/3-ActiveModel-Integration.html">ActiveModel Integration</a></li><li><a href="#" class="isLabel">Modules</a><div class="arrow right"></div><ul><li><a href="/elastics/doc/4-elastics-models/4-Modules/1-Elastics::ModelSyncer.html">Elastics::ModelSyncer</a></li><li><a href="/elastics/doc/4-elastics-models/4-Modules/2-Elastics::ModelIndexer.html">Elastics::ModelIndexer</a></li><li><a href="/elastics/doc/4-elastics-models/4-Modules/3-Elastics::ActiveModel.html">Elastics::ActiveModel</a></li></ul></li><li><a href="/elastics/doc/4-elastics-models/5-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">elastics-rails</a><ul><li><a href="/elastics/doc/5-elastics-rails/1-Overview.html">Overview</a></li><li><a href="/elastics/doc/5-elastics-rails/2-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">elastics-admin</a><ul><li><a href="/elastics/doc/6-elastics-admin/1-Binary.html">Binary</a></li><li><a href="/elastics/doc/6-elastics-admin/2-Live-Reindex.html">Live Reindex</a></li></ul></li><li><a href="#" class="isLabel">tutorials</a><ul><li><a href="/elastics/doc/7-tutorials/1-Elastics-vs-Tire.html">Why you should use Elastics rather than Tire</a></li><li><a href="/elastics/doc/7-tutorials/2-Migrate-from-0.x.html">How to migrate from Flex 0.x</a></li><li><a href="/elastics/doc/7-tutorials/3-Index-and-Search-your-Models.html">Index and Search your Models</a></li><li><a href="/elastics/doc/7-tutorials/4-Index-and-Search-External-Data.html">Index and Search External Data</a></li></ul></li></ul>
      <div id="google-search">
        <script type="text/javascript">
          (function() {
            var cx = '001168365143071728136:w4opkcwdl3y';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
        <gcse:search>&nbsp;</gcse:search>
      </div>
    </div>
    <div id="page-toc">
      <div id="logo">
        <img src="/elastics/images/elastics-logo-200.png" />
      </div>
    </div>
    <div id="content">
      <a id="badge" href="https://badge.fury.io/rb/elastics-models"><img src="https://badge.fury.io/rb/elastics-models.png" /></a>
      <div class="breadcrumb nocontent">
        <span><a href="/elastics/doc">Elastics</a></span> &gt; <span><a href="/elastics/doc/4-elastics-models">elastics-models</a></span> &gt; <span><a href="/elastics/doc/4-elastics-models/4-Modules">Modules</a></span> &gt; <span>Elastics::ActiveModel</span>
      </div>
      <h1 id="elasticsactivemodel">Elastics::ActiveModel</h1>

<p>The <code>Elastics::ActiveModel</code> inclues the <code>Elastics::ModelIndexer</code>, which includes <code>Elastics::ModelSyncer</code> so you can use their method too (see <a href="/elastics/doc/4-elastics-models/4-Modules/2-Elastics::ModelIndexer.html">Elastics::ModelIndexer</a> and <a href="/elastics/doc/4-elastics-models/4-Modules/1-Elastics::ModelSyncer.html">Elastics::ModelSyncer</a>). Besides it includes the <code>ActiveAttr::Model</code> module from the <a href="https://github.com/cgriego/active_attr">active_attr</a>, and the <code>ActiveModel</code> validations and callbacks, so refer to them for the documentation.</p>

<blockquote>
  <p>We list here only the specific methods or overrides that are not documented elsewhere. We also omit the standard CRUD methods that <code>Elastics::ActiveModel</code> implements on its own but behave like in standard <code>ActiveRecord</code>.</p>
</blockquote>

<h2 id="class-methods">Class Methods</h2>

<table class="code-topics" id="activemodel-class-methods" cellspacing="0" cellpadding="0">
  <tr>
    <td>
      <code>attribute :properties</code>
    </td>
    <td><p>The <code>attribute</code> method is implemented by <a href="https://github.com/cgriego/active_attr">active_attr</a>. <code>Elastics::ActiveModel</code> extends it so it accepts a <code>:properties</code> argument that is used to generate the mapping.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:properties</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;float&#39;</span><span class="p">},</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span></code></pre></div>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute :analyzed</code>
    </td>
    <td><p>The <code>attribute</code> method is implemented by <a href="https://github.com/cgriego/active_attr">active_attr</a>. <code>Elastics::ActiveModel</code> extends it so it accepts a <code>:analyzed</code> argument that is expanded to <code>:properties =&gt; { &#39;type&#39; =&gt; &#39;string&#39;, &#39;index&#39; =&gt; &#39;not_analyzed&#39; }</code> and used to generate the mapping.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:code</span><span class="p">,</span> <span class="ss">:analyzed</span> <span class="o">=&gt;</span> <span class="kp">false</span></code></pre></div>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute :not_analyzed</code>
    </td>
    <td><p>Same as <code>:analized</code> but with inverted logic</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:code</span><span class="p">,</span> <span class="ss">:not_analyzed</span> <span class="o">=&gt;</span> <span class="kp">true</span></code></pre></div>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute_created_at</code>
    </td>
    <td><p>Adds the <code>created_at</code> attribute wich will be automatically filled by the date of the creation.</p>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute_updated_at</code>
    </td>
    <td><p>Adds the <code>updated_at</code> attribute wich will be automatically filled by the date of the update.</p>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute_timestamps</code>
    </td>
    <td><p>Shortcut that calls both <code>attribute_created_at</code> and <code>attribute_updated_at</code>.</p>

    </td>
  </tr>
  <tr>
    <td>
      <code>attribute_attachment</code>
    </td>
    <td><p>Defines an attachment attribute that integrates with <a href="https://github.com/elasticsearch/elasticsearch-mapper-attachments">elasticsearch-mapper-attachments</a>:</p>

<ul>
<li>if you omit the arguments it uses <code>:attachment</code> as the <code>&lt;attachment_field_name&gt;</code></li>
<li>you can also pass other properties that will be merged with the default property for attachment</li>
<li>it automatically adds a <code>:&lt;attachment_field_name&gt;_scope</code> scope which will add all the meta fields (title, author, ...) to the returned fields, exluding the <code>&lt;attachment_field_name&gt;</code> field itself, and including all the other attributes declared <strong>before</strong> it. For that reason you may want to declare it as the latest attribute.</li>
</ul>

<p>You can rely on the defaults, or you can override what you need. For example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># adds a default &#39;attachment&#39; attribute and a &#39;attachment_scope&#39; scope</span>
<span class="n">attribute_attachment</span>
<span class="c1"># adds a &#39;page&#39; attribute and a &#39;page_scope&#39; scope</span>
<span class="n">attribute_attachment</span> <span class="ss">:page</span>
<span class="c1"># adds a &#39;file&#39; attribute with explicit properties and a &#39;file_scope&#39; scope</span>
<span class="n">attribute_attachment</span> <span class="ss">:file</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:properties</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;file&#39;</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;index&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;no&#39;</span> <span class="p">},</span>
                                                             <span class="s1">&#39;title&#39;</span>  <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;store&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;yes&#39;</span> <span class="p">},</span>
                                                             <span class="s1">&#39;author&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;analyzer&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;myAnalizer&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>

<span class="c1"># a scope that returns the added fields, highlights and a query</span>
<span class="n">scope</span> <span class="ss">:searchable</span> <span class="k">do</span> <span class="o">|</span><span class="n">query</span><span class="o">|</span>
   <span class="n">attachment_scope</span>
  <span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="ss">:fields</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:attachment</span>          <span class="o">=&gt;</span> <span class="p">{},</span>
                          <span class="ss">:&#39;attachment.title&#39;</span>  <span class="o">=&gt;</span> <span class="p">{},</span>
                          <span class="ss">:&#39;attachment.author&#39;</span> <span class="o">=&gt;</span> <span class="p">{}</span> <span class="p">})</span>
  <span class="o">.</span><span class="n">query_string</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># pass the attachments as encoded strings, as required by the plugin</span>
<span class="no">MyModel</span><span class="o">.</span><span class="n">create</span> <span class="ss">:my_attr</span>    <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
               <span class="ss">:attachment</span> <span class="o">=&gt;</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">the_attachment</span><span class="p">),</span>
               <span class="ss">:page</span>       <span class="o">=&gt;</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">the_page</span><span class="p">),</span>
               <span class="ss">:file</span>       <span class="o">=&gt;</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">the_file</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="no">MyModel</span><span class="o">.</span><span class="n">searchable</span><span class="p">(</span><span class="n">the_query_string</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>

<span class="c1"># the nested fields like &#39;page.title&#39; and &#39;page.author&#39; are accessible in ruby as flattened-name methods</span>
<span class="nb">puts</span> <span class="n">result</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">page_author</span></code></pre></div>

    </td>
  </tr>
</table>

<h2 id="instance-methods">Instance Methods</h2>

<table class="code-topics" id="activemodel-instance-methods" cellspacing="0" cellpadding="0">
  <tr>
    <td>
      <code>safe_update</code>
    </td>
    <td>
      <p>This method implements the optimistic lock on update documented <a href="http://www.elasticsearch.org/blog/2011/02/08/versioning.html">here</a>. It is done through a simple block wrapper:</p>
      
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">record</span><span class="o">.</span><span class="n">safe_update</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
  <span class="n">r</span><span class="o">.</span><span class="n">amount</span> <span class="o">+=</span> <span class="mi">100</span>
<span class="k">end</span></code></pre></div>
<p>If you are trying to update a stale object, the block is yielded again with a fresh reloaded document and the
document is saved only when it is not stale anymore (i.e. the <code>_version</code> has not changed since it has been loaded).</p>

    </td>
  </tr>
  <tr>
    <td>
      <code>safe_update!</code>
    </td>
    <td><p>Like <code>safe_update</code> but will raise a <code>Elastics::ActiveModel::DocumentInvalidError</code> if the document is not valid.</p>

    </td>
  </tr>
  <tr>
    <td>
      <code>raw_result</code>
    </td>
    <td>
      <p>This method returns the original elasticsearch result as it comes from the internal request. You can call it also on any array collection result.</p>
      
    </td>
  </tr>
  <tr>
    <td>
      <code>raw_document</code>
    </td>
    <td>
      <p>This method returns the original elasticsearch document as it comes from the internal request.</p>
      
    </td>
  </tr>
  <tr>
    <td>
      <code>elastics_id</code>
    </td>
    <td><p>You define this method if you want to manage the elasticsearch document id yourself. That is specially useful in certain contexts, when you may need to create a new document or update an old one, based on certain attributes (that identify the record). For example, you may want to reindex a document when it has the same <code>source</code> and <code>date</code>, while you want to create a new one if there is no document with that <code>title</code> and <code>date</code>. You may be tempted to query the index for the presence of the document, so decide to update or create, but there is an easier way: just generate an id based on <code>title</code> and <code>date</code> and that behaviour will happen automatically. For example:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">elastics_id</span>
  <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span> <span class="o">[</span><span class="n">title</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="ss">:date</span><span class="p">)</span><span class="o">].</span><span class="n">join</span>
<span class="k">end</span></code></pre></div>
<br />(see <a href="/elastics/doc/4-elastics-models/4-Modules/2-Elastics::ModelIndexer.html#overriding_elastics_metafields">Overriding Elastics Metafields</a>)
    </td>
  </tr>
  <tr>
    <td>
      <code>document.method_missing</code>
    </td>
    <td><p>This method forwards the missing methods <code>raw_document</code> structure, so you can also call all the methods added by all the result extenders (see <a href="/elastics/doc/2-elastics-client/4-Result-Extenders.html">elastics Result Extenders</a> and <a href="/elastics/doc/4-elastics-models/5-Result-Extenders.html">elastics-models Result Extenders</a>)</p>

    </td>
  </tr>
</table>

<h2 id="elasticsrefreshcallback">Elastics::RefreshCallback</h2>

<p>You can include this module if you want elastics to refresh the index automatically. It will add 2 callbacks: <code>after_save</code> and <code>after_destroy</code> with a call to the <code>Elastics.refresh_index</code> API method.</p>

<br />
      <div class="breadcrumb nocontent">
        <span><a href="/elastics/doc">Elastics</a></span> &gt; <span><a href="/elastics/doc/4-elastics-models">elastics-models</a></span> &gt; <span><a href="/elastics/doc/4-elastics-models/4-Modules">Modules</a></span> &gt; <span>Elastics::ActiveModel</span>
      </div>
    </div>
    <div id="footer" class="nocontent">
      Copyright &copy; 2012-2013 by <a href="mailto://dd.nexus@gmail.com">Domizio Demichelis</a> &mdash; Sponsored by <a href="http://www.escalatemedia.com">Escalate Media</a> and <a href="http://www.barquin.com">Barquin International</a>
    </div>
  </body>
</html>